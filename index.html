<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SolBot Dashboard</title>
  <style>
    :root {
      --bg-color: #1a1b1f;
      --card-bg: #232428;
      --text-color: #ffffff;
      --primary-color: #5865f2;
      --border-radius: 10px;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      margin: 0;
    }

    .container {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--border-radius);
      max-width: 400px;
      width: 100%;
      text-align: center;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
    }

    h1 {
      font-size: 1.8rem;
      margin-bottom: 1.5rem;
      color: var(--primary-color);
    }

    button#loginBtn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: var(--border-radius);
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 100%;
    }

    button#loginBtn:hover {
      background-color: #4752c4;
    }

    #user {
      margin-top: 1.5rem;
    }

    #avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid var(--primary-color);
      margin-top: 1rem;
    }

    .hidden {
      display: none !important;
    }

    #callback .container {
      max-width: 500px;
    }

    #loading {
      margin-top: 1rem;
      color: #aaa;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div class="container" id="main">
    <h1>SolBot Dashboard</h1>
    <button id="loginBtn">Login with Discord</button>

    <div id="user" class="hidden">
      <h2>Welcome, <span id="username"></span>!</h2>
      <img id="avatar" src="" alt="Avatar" />
    </div>
  </div>

  <div class="container hidden" id="callback">
    <h1>Verification Complete</h1>
    <p id="loading">Redirecting to dashboard...</p>
  </div>

  <script>
    // DOM Elements
    const loginBtn = document.getElementById('loginBtn');
    const userDiv = document.getElementById('user');
    const usernameSpan = document.getElementById('username');
    const avatarImg = document.getElementById('avatar');

    const mainContainer = document.getElementById('main');
    const callbackContainer = document.getElementById('callback');
    const loadingEl = document.getElementById('loading');

    // Configuration
    const CLIENT_ID = '1338188377559666730'; // Replace with your Discord Client ID
    const REDIRECT_URI = encodeURIComponent('https://solbot.store/api/auth/callback');
    const SCOPE = 'identify%20guilds%20email%20guilds.members.read';
    const DISCORD_AUTH_URL = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${REDIRECT_URI}&scope=${SCOPE}`;

    // Show loading spinner
    function showLoading(message = "Redirecting...") {
      if (loadingEl) {
        loadingEl.textContent = message;
        loadingEl.classList.remove('hidden');
      }
    }

    // Handle Login Click
    if (loginBtn) {
      loginBtn.addEventListener('click', () => {
        window.location.href = DISCORD_AUTH_URL;
      });
    }

    // Check current path
    if (window.location.pathname === '/api/auth/callback') {
      // Hide main content, show callback UI
      if (mainContainer) mainContainer.style.display = 'none';
      if (callbackContainer) callbackContainer.style.display = 'block';
      showLoading("Authenticating...");

      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');

      if (!code) {
        alert('Authentication failed: No code found.');
        window.location.href = '/';
        return;
      }

      // Exchange code for access token
      fetch('/api/exchange-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code }),
      })
        .then(res => {
          if (!res.ok) throw new Error('Failed to exchange code');
          return res.json();
        })
        .then(data => {
          const { access_token } = data;

          // Fetch User Info
          return fetch('https://discord.com/api/users/@me', {
            headers: { authorization: `Bearer ${access_token}` },
          }).then(res => {
            if (!res.ok) throw new Error('Failed to fetch user data');
            return res.json();
          }).then(userData => {
            localStorage.setItem('discordUser', JSON.stringify(userData));

            // Fetch User Guilds
            return fetch('https://discord.com/api/users/@me/guilds', {
              headers: { authorization: `Bearer ${access_token}` },
            }).then(res => {
              if (!res.ok) throw new Error('Failed to fetch guild data');
              return res.json();
            }).then(guildData => {
              localStorage.setItem('discordGuilds', JSON.stringify(guildData));

              // Redirect to dashboard.html
              window.location.href = '/dashboard.html';
            });
          });
        })
        .catch(err => {
          console.error('‚ùå Auth failed:', err);
          alert('Authentication failed. Please try again.');
          window.location.href = '/';
        });
    } else {
      // Main Page Logic
      const storedUser = localStorage.getItem('discordUser');
      const user = storedUser ? JSON.parse(storedUser) : null;

      if (mainContainer) mainContainer.style.display = 'block';

      // Show user info if logged in
      if (user) {
        usernameSpan.textContent = `${user.username}#${user.discriminator}`;
        avatarImg.src = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
        userDiv.classList.remove('hidden');
        if (loginBtn) loginBtn.style.display = 'none';
      } else {
        if (loginBtn) loginBtn.style.display = 'inline-block';
        userDiv.classList.add('hidden');
      }
    }
  </script>
</body>
</html>
